# è±†åŒ…å®æ—¶è¯­éŸ³å¯¹è¯ç³»ç»Ÿ - æ¥å…¥æ–¹æ¡ˆä¸å»ºè®®

  

## ğŸ“‹ ç›®å½•

  

1. [é¡¹ç›®ç°çŠ¶åˆ†æ](#é¡¹ç›®ç°çŠ¶åˆ†æ)

2. [æ¥å…¥æ–¹æ¡ˆæ¦‚è¿°](#æ¥å…¥æ–¹æ¡ˆæ¦‚è¿°)

3. [è¯¦ç»†é›†æˆæ–¹æ¡ˆ](#è¯¦ç»†é›†æˆæ–¹æ¡ˆ)

4. [æ¶æ„è®¾è®¡å»ºè®®](#æ¶æ„è®¾è®¡å»ºè®®)

5. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

6. [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)

7. [å¸¸è§åœºæ™¯å®ç°](#å¸¸è§åœºæ™¯å®ç°)

8. [æ³¨æ„äº‹é¡¹ä¸é£é™©](#æ³¨æ„äº‹é¡¹ä¸é£é™©)

  

---

  

## 1. é¡¹ç›®ç°çŠ¶åˆ†æ

  

### 1.1 ç°æœ‰ç³»ç»Ÿç»„ä»¶

  

æ ¹æ®é¡¹ç›®ç»“æ„åˆ†æï¼Œæ‚¨çš„ç³»ç»ŸåŒ…å«ï¼š

  

```

YiTiJi_Move/

â”œâ”€â”€ MessageCenter (äº‹ä»¶æ€»çº¿ç³»ç»Ÿ)

â”œâ”€â”€ AIChatToolkit (ç°æœ‰è¯­éŸ³è¯†åˆ«ç³»ç»Ÿ)

â”‚ Â  â”œâ”€â”€ Speech (è®¯é£è¯­éŸ³è¯†åˆ«)

â”‚ Â  â”œâ”€â”€ VoiceDetector (è¯­éŸ³æ£€æµ‹)

â”‚ Â  â”œâ”€â”€ Audio2LipScript (å£å‹åŒæ­¥)

â”‚ Â  â””â”€â”€ XunFeiWakeUpManager (å”¤é†’è¯æ£€æµ‹)

â”œâ”€â”€ Unity-chan (è§’è‰²æ¨¡å‹)

â”œâ”€â”€ LogSystem (æ—¥å¿—ç³»ç»Ÿ)

â””â”€â”€ Animation System (åŠ¨ç”»ç®¡ç†)

```

  

### 1.2 ç°æœ‰æŠ€æœ¯æ ˆ

  

- **è¯­éŸ³è¯†åˆ«**ï¼šç§‘å¤§è®¯é£ (MSCDLL)

- **äº‹ä»¶ç³»ç»Ÿ**ï¼šè‡ªå®šä¹‰ MessageCenter

- **è§’è‰²åŠ¨ç”»**ï¼šUnity Animator + SpringBone

- **å£å‹åŒæ­¥**ï¼šOVRLipSync / Audio2Lip

- **æ—¥å¿—ç³»ç»Ÿ**ï¼šè‡ªå®šä¹‰ LogManager

  

### 1.3 ä¸è±†åŒ…çš„å¯¹æ¯”

  

| åŠŸèƒ½ | ç°æœ‰ç³»ç»Ÿ (è®¯é£) | è±†åŒ…å®æ—¶å¯¹è¯ |

|------|----------------|-------------|

| è¯­éŸ³è¯†åˆ« | âœ… å•å‘ASR | âœ… åŒå‘å®æ—¶ASR |

| AIå¯¹è¯ | âŒ éœ€è¦é¢å¤–å¯¹æ¥ | âœ… å†…ç½®å¤§æ¨¡å‹ |

| è¯­éŸ³åˆæˆ | âŒ éœ€è¦é¢å¤–å¯¹æ¥ | âœ… å†…ç½®TTS |

| å®æ—¶æ€§ | ğŸŸ¡ è¾ƒå¥½ | âœ… æä½³ (ç«¯åˆ°ç«¯) |

| é›†æˆéš¾åº¦ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¡ ä¸­ç­‰ |

| æˆæœ¬ | ğŸ’° æŒ‰æ¬¡æ”¶è´¹ | ğŸ’° æŒ‰æ—¶é•¿æ”¶è´¹ |

  

---

  

## 2. æ¥å…¥æ–¹æ¡ˆæ¦‚è¿°

  

### 2.1 ä¸‰ç§é›†æˆç­–ç•¥

  

#### æ–¹æ¡ˆAï¼šå®Œå…¨æ›¿æ¢ï¼ˆæ¨èâ­â­â­â­â­ï¼‰

  

**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦å®Œæ•´çš„è¯­éŸ³å¯¹è¯ä½“éªŒ

  

**ä¼˜ç‚¹**ï¼š

- âœ… ç«¯åˆ°ç«¯å®æ—¶ä½“éªŒæœ€ä½³

- âœ… åŠŸèƒ½æœ€å®Œæ•´ï¼ˆASR + AI + TTSï¼‰

- âœ… å»¶è¿Ÿæœ€ä½

- âœ… ç»´æŠ¤æˆæœ¬ä½

  

**ç¼ºç‚¹**ï¼š

- âŒ éœ€è¦æ›¿æ¢ç°æœ‰è¯­éŸ³è¯†åˆ«

- âŒ å­¦ä¹ æˆæœ¬ç¨é«˜

  

**å®æ–½éš¾åº¦**ï¼šâ­â­â­

  

```

åŸç³»ç»Ÿ: éº¦å…‹é£ â†’ è®¯é£ASR â†’ æ–‡æœ¬ â†’ ChatGPT â†’ æ–‡æœ¬ â†’ è®¯é£TTS â†’ æ’­æ”¾

æ–°ç³»ç»Ÿ: éº¦å…‹é£ â†’ è±†åŒ…ç«¯åˆ°ç«¯ â†’ æ’­æ”¾

```

  

---

  

#### æ–¹æ¡ˆBï¼šæ··åˆå…±å­˜ï¼ˆçµæ´»â­â­â­â­ï¼‰

  

**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦ä¿ç•™åŸç³»ç»Ÿï¼Œé€æ­¥è¿ç§»

  

**ä¼˜ç‚¹**ï¼š

- âœ… å…¼å®¹æ€§å¥½ï¼Œé£é™©ä½

- âœ… å¯æŒ‰éœ€åˆ‡æ¢

- âœ… ä¿ç•™åŸæœ‰åŠŸèƒ½

  

**ç¼ºç‚¹**ï¼š

- âŒ ç»´æŠ¤ä¸¤å¥—ç³»ç»Ÿ

- âŒ ä»£ç å¤æ‚åº¦å¢åŠ 

  

**å®æ–½éš¾åº¦**ï¼šâ­â­â­â­

  

```csharp

public enum VoiceMode

{

Â  Â  XunFei, Â  // ä½¿ç”¨è®¯é£

Â  Â  DouBao Â  Â // ä½¿ç”¨è±†åŒ…

}

  

public class VoiceManager

{

Â  Â  private VoiceMode currentMode = VoiceMode.DouBao;

  

Â  Â  public void ProcessVoice()

Â  Â  {

Â  Â  Â  Â  switch(currentMode)

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  case VoiceMode.XunFei:

Â  Â  Â  Â  Â  Â  Â  Â  // ä½¿ç”¨è®¯é£æµç¨‹

Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  case VoiceMode.DouBao:

Â  Â  Â  Â  Â  Â  Â  Â  // ä½¿ç”¨è±†åŒ…æµç¨‹

Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  }

Â  Â  }

}

```

  

---

  

#### æ–¹æ¡ˆCï¼šåˆ†åœºæ™¯ä½¿ç”¨ï¼ˆæŒ‰éœ€â­â­â­ï¼‰

  

**é€‚ç”¨åœºæ™¯**ï¼šä¸åŒåŠŸèƒ½ä½¿ç”¨ä¸åŒæœåŠ¡

  

**ç¤ºä¾‹**ï¼š

- ç®€å•è¯†åˆ«ï¼ˆå‘½ä»¤è¯ï¼‰â†’ è®¯é£

- å¤æ‚å¯¹è¯ï¼ˆAIäº¤äº’ï¼‰â†’ è±†åŒ…

- ç¦»çº¿è¯†åˆ« â†’ è®¯é£

- åœ¨çº¿æ™ºèƒ½å¯¹è¯ â†’ è±†åŒ…

  

**ä¼˜ç‚¹**ï¼š

- âœ… æˆæœ¬å¯æ§

- âœ… å‘æŒ¥å„è‡ªä¼˜åŠ¿

  

**ç¼ºç‚¹**ï¼š

- âŒ åˆ‡æ¢å¤æ‚

- âŒ ç”¨æˆ·ä½“éªŒå¯èƒ½ä¸ä¸€è‡´

  

**å®æ–½éš¾åº¦**ï¼šâ­â­â­â­â­

  

---

  

## 3. è¯¦ç»†é›†æˆæ–¹æ¡ˆ

  

### 3.1 æ¶æ„è®¾è®¡ï¼ˆæ¨èæ–¹æ¡ˆAï¼‰

  

```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Application Layer Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â  Â â”‚

â”‚ Â â”‚ Â UI Manager â”‚ Â â”‚ Unity-chan Â  â”‚ Â â”‚ Â Animation Â â”‚ Â  Â â”‚

â”‚ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â  Â â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚ Events (MessageCenter)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Â  Â  Â  Â  Â Voice Dialog Manager (æ–°å¢) Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â â”‚

â”‚ Â â”‚ Â  Â  Â  Â  Â  Â IVoiceDialogService (æ¥å£) Â  Â  Â  Â  Â  Â  â”‚ Â â”‚

â”‚ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â â”‚

â”‚ Â  Â  Â  Â  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â  Â  Â  Â â”‚

â”‚ Â  Â  Â  Â  â–¼ Â  Â  Â  Â  Â  Â  Â  Â  Â â–¼ Â  Â  Â  Â  Â  Â  Â  Â  Â â–¼ Â  Â  Â  Â â”‚

â”‚ Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â â”‚

â”‚ Â â”‚ Â  è±†åŒ…å®ç° Â  â”‚ Â â”‚ Â  è®¯é£å®ç° Â  Â â”‚ Â â”‚ Â  Mockå®ç° Â  â”‚ Â â”‚

â”‚ Â â”‚ (æ¨èä¸»ç”¨) Â  â”‚ Â â”‚ Â (å¤‡ç”¨æ–¹æ¡ˆ) Â  â”‚ Â â”‚ Â  (æµ‹è¯•ç”¨) Â  â”‚ Â â”‚

â”‚ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Audio & Network Layer Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â  â”‚

â”‚ Â â”‚ Microphone â”‚ Â â”‚ Â AudioSource â”‚ Â â”‚ Â WebSocket Â  â”‚ Â  â”‚

â”‚ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â  â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

  

---

  

### 3.2 æ ¸å¿ƒç±»è®¾è®¡

  

#### 3.2.1 è¯­éŸ³å¯¹è¯æœåŠ¡æ¥å£

  

```csharp

/// <summary>

/// è¯­éŸ³å¯¹è¯æœåŠ¡ç»Ÿä¸€æ¥å£

/// </summary>

public interface IVoiceDialogService

{

Â  Â  // ç”Ÿå‘½å‘¨æœŸ

Â  Â  void Initialize(object config);

Â  Â  void Connect();

Â  Â  void Disconnect();

  

Â  Â  // ä¼šè¯æ§åˆ¶

Â  Â  void StartSession();

Â  Â  void EndSession();

  

Â  Â  // éŸ³é¢‘è¾“å…¥

Â  Â  void StartListening();

Â  Â  void StopListening();

Â  Â  void SendAudioData(byte[] audioData);

  

Â  Â  // æ–‡æœ¬è¾“å…¥

Â  Â  void SendTextMessage(string text);

  

Â  Â  // äº‹ä»¶å›è°ƒ

Â  Â  event Action OnConnected;

Â  Â  event Action<string> OnUserSpeechRecognized; Â  Â // ASRç»“æœ

Â  Â  event Action<string> OnAIResponseReceived; Â  Â  Â // AIå›å¤æ–‡æœ¬

Â  Â  event Action<byte[]> OnAIAudioReceived; Â  Â  Â  Â  // AIå›å¤éŸ³é¢‘

Â  Â  event Action<string> OnError;

  

Â  Â  // çŠ¶æ€æŸ¥è¯¢

Â  Â  bool IsConnected { get; }

Â  Â  bool IsListening { get; }

}

```

  

#### 3.2.2 è±†åŒ…æœåŠ¡å®ç°

  

```csharp

using VolcEngine.RealtimeDialog;

  

/// <summary>

/// è±†åŒ…å®æ—¶å¯¹è¯æœåŠ¡å®ç°

/// </summary>

public class DouBaoVoiceService : MonoBehaviour, IVoiceDialogService

{

Â  Â  private IRealtimeDialogAPI _api;

Â  Â  private bool _isInitialized;

  

Â  Â  public bool IsConnected => _api?.IsConnected ?? false;

Â  Â  public bool IsListening => _api?.IsMicrophoneRecording ?? false;

  

Â  Â  // äº‹ä»¶

Â  Â  public event Action OnConnected;

Â  Â  public event Action<string> OnUserSpeechRecognized;

Â  Â  public event Action<string> OnAIResponseReceived;

Â  Â  public event Action<byte[]> OnAIAudioReceived;

Â  Â  public event Action<string> OnError;

  

Â  Â  public void Initialize(object config)

Â  Â  {

Â  Â  Â  Â  if (_isInitialized) return;

  

Â  Â  Â  Â  // åˆ›å»ºè±†åŒ…APIå®ä¾‹

Â  Â  Â  Â  _api = gameObject.AddComponent<RealtimeDialogClient>();

  

Â  Â  Â  Â  // é…ç½®

Â  Â  Â  Â  RTDConfig rtdConfig = config as RTDConfig;

Â  Â  Â  Â  _api.Initialize(rtdConfig);

  

Â  Â  Â  Â  // æ³¨å†Œäº‹ä»¶

Â  Â  Â  Â  _api.OnConnected += () => OnConnected?.Invoke();

Â  Â  Â  Â  _api.OnASRTextReceived += (text, isInterim) =>

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  if (!isInterim) OnUserSpeechRecognized?.Invoke(text);

Â  Â  Â  Â  };

Â  Â  Â  Â  _api.OnChatTextReceived += (text, isInterim) =>

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  if (!isInterim) OnAIResponseReceived?.Invoke(text);

Â  Â  Â  Â  };

Â  Â  Â  Â  _api.OnAudioReceived += (audioData) => OnAIAudioReceived?.Invoke(audioData);

Â  Â  Â  Â  _api.OnError += (error, code) => OnError?.Invoke($"[{code}] {error}");

  

Â  Â  Â  Â  _isInitialized = true;

Â  Â  }

  

Â  Â  public void Connect() => _api?.Connect();

Â  Â  public void Disconnect() => _api?.Disconnect();

Â  Â  public void StartSession() => _api?.StartSession();

Â  Â  public void EndSession() => _api?.EndSession();

Â  Â  public void StartListening() => _api?.StartMicrophone();

Â  Â  public void StopListening() => _api?.StopMicrophone();

Â  Â  public void SendAudioData(byte[] audioData) => _api?.SendAudioData(audioData);

Â  Â  public void SendTextMessage(string text) => _api?.SendTextQuery(text);

}

```

  

#### 3.2.3 è¯­éŸ³å¯¹è¯ç®¡ç†å™¨

  

```csharp

/// <summary>

/// ç»Ÿä¸€çš„è¯­éŸ³å¯¹è¯ç®¡ç†å™¨

/// æ•´åˆåˆ°ç°æœ‰MessageCenterç³»ç»Ÿ

/// </summary>

public class VoiceDialogManager : MonoBehaviour

{

Â  Â  [Header("æœåŠ¡ç±»å‹é€‰æ‹©")]

Â  Â  [SerializeField] private ServiceType serviceType = ServiceType.DouBao;

  

Â  Â  [Header("è±†åŒ…é…ç½®")]

Â  Â  [SerializeField] private RTDConfig douBaoConfig;

  

Â  Â  private IVoiceDialogService _currentService;

Â  Â  private static VoiceDialogManager _instance;

  

Â  Â  public static VoiceDialogManager Instance => _instance;

  

Â  Â  public enum ServiceType

Â  Â  {

Â  Â  Â  Â  DouBao,

Â  Â  Â  Â  XunFei,

Â  Â  Â  Â  Mock

Â  Â  }

  

Â  Â  void Awake()

Â  Â  {

Â  Â  Â  Â  if (_instance != null && _instance != this)

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  Destroy(gameObject);

Â  Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  }

Â  Â  Â  Â  _instance = this;

Â  Â  Â  Â  DontDestroyOnLoad(gameObject);

  

Â  Â  Â  Â  InitializeService();

Â  Â  }

  

Â  Â  private void InitializeService()

Â  Â  {

Â  Â  Â  Â  switch (serviceType)

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  case ServiceType.DouBao:

Â  Â  Â  Â  Â  Â  Â  Â  var douBao = gameObject.AddComponent<DouBaoVoiceService>();

Â  Â  Â  Â  Â  Â  Â  Â  douBao.Initialize(douBaoConfig);

Â  Â  Â  Â  Â  Â  Â  Â  _currentService = douBao;

Â  Â  Â  Â  Â  Â  Â  Â  break;

  

Â  Â  Â  Â  Â  Â  case ServiceType.XunFei:

Â  Â  Â  Â  Â  Â  Â  Â  // ä½¿ç”¨åŸæœ‰è®¯é£ç³»ç»Ÿçš„é€‚é…å™¨

Â  Â  Â  Â  Â  Â  Â  Â  // var xunfei = gameObject.AddComponent<XunFeiVoiceService>();

Â  Â  Â  Â  Â  Â  Â  Â  // _currentService = xunfei;

Â  Â  Â  Â  Â  Â  Â  Â  break;

  

Â  Â  Â  Â  Â  Â  case ServiceType.Mock:

Â  Â  Â  Â  Â  Â  Â  Â  // æµ‹è¯•ç”¨Mockå®ç°

Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  }

  

Â  Â  Â  Â  RegisterEvents();

Â  Â  }

  

Â  Â  private void RegisterEvents()

Â  Â  {

Â  Â  Â  Â  _currentService.OnConnected += OnServiceConnected;

Â  Â  Â  Â  _currentService.OnUserSpeechRecognized += OnUserSpeech;

Â  Â  Â  Â  _currentService.OnAIResponseReceived += OnAIResponse;

Â  Â  Â  Â  _currentService.OnAIAudioReceived += OnAIAudio;

Â  Â  Â  Â  _currentService.OnError += OnServiceError;

Â  Â  }

  

Â  Â  // === å¯¹å¤–æ¥å£ ===

  

Â  Â  public void StartConversation()

Â  Â  {

Â  Â  Â  Â  _currentService.Connect();

Â  Â  }

  

Â  Â  public void EndConversation()

Â  Â  {

Â  Â  Â  Â  _currentService.Disconnect();

Â  Â  }

  

Â  Â  public void StartListening()

Â  Â  {

Â  Â  Â  Â  if (!_currentService.IsConnected)

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  Debug.LogWarning("æœåŠ¡æœªè¿æ¥");

Â  Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  }

Â  Â  Â  Â  _currentService.StartListening();

Â  Â  }

  

Â  Â  public void StopListening()

Â  Â  {

Â  Â  Â  Â  _currentService.StopListening();

Â  Â  }

  

Â  Â  public void SendText(string text)

Â  Â  {

Â  Â  Â  Â  _currentService.SendTextMessage(text);

Â  Â  }

  

Â  Â  // === äº‹ä»¶å¤„ç† ===

  

Â  Â  private void OnServiceConnected()

Â  Â  {

Â  Â  Â  Â  Debug.Log("[VoiceDialogManager] æœåŠ¡å·²è¿æ¥");

Â  Â  Â  Â  MessageCenter.Publish("Voice_Connected");

  

Â  Â  Â  Â  // è‡ªåŠ¨å¼€å§‹ä¼šè¯

Â  Â  Â  Â  _currentService.StartSession();

Â  Â  }

  

Â  Â  private void OnUserSpeech(string text)

Â  Â  {

Â  Â  Â  Â  Debug.Log($"[VoiceDialogManager] ç”¨æˆ·è¯´: {text}");

Â  Â  Â  Â  MessageCenter.Publish("Voice_UserSpeech", text);

  

Â  Â  Â  Â  // é€šçŸ¥è§’è‰²åšå‡ºååº”ï¼ˆä¾‹å¦‚ï¼šåœæ­¢é—²ç½®åŠ¨ç”»ï¼Œçœ‹å‘ç”¨æˆ·ï¼‰

Â  Â  Â  Â  MessageCenter.Publish("Character_UserSpeaking");

Â  Â  }

  

Â  Â  private void OnAIResponse(string text)

Â  Â  {

Â  Â  Â  Â  Debug.Log($"[VoiceDialogManager] AIå›å¤: {text}");

Â  Â  Â  Â  MessageCenter.Publish("Voice_AIResponse", text);

  

Â  Â  Â  Â  // æ˜¾ç¤ºåœ¨UIä¸Š

Â  Â  Â  Â  MessageCenter.Publish("UI_ShowAIText", text);

Â  Â  }

  

Â  Â  private void OnAIAudio(byte[] audioData)

Â  Â  {

Â  Â  Â  Â  Debug.Log($"[VoiceDialogManager] æ”¶åˆ°AIéŸ³é¢‘: {audioData.Length} å­—èŠ‚");

  

Â  Â  Â  Â  // è§¦å‘å£å‹åŒæ­¥

Â  Â  Â  Â  MessageCenter.Publish("LipSync_StartWithAudio", audioData);

  

Â  Â  Â  Â  // æ’­æ”¾éŸ³é¢‘

Â  Â  Â  Â  PlayAIAudio(audioData);

Â  Â  }

  

Â  Â  private void OnServiceError(string error)

Â  Â  {

Â  Â  Â  Â  Debug.LogError($"[VoiceDialogManager] é”™è¯¯: {error}");

Â  Â  Â  Â  MessageCenter.Publish("Voice_Error", error);

Â  Â  }

  

Â  Â  private void PlayAIAudio(byte[] audioData)

Â  Â  {

Â  Â  Â  Â  // TODO: è§£ç OGG/OpuséŸ³é¢‘å¹¶æ’­æ”¾

Â  Â  Â  Â  // éœ€è¦é›†æˆOpusè§£ç å™¨

Â  Â  }

}

```

  

---

  

### 3.3 ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ

  

#### 3.3.1 é›†æˆMessageCenter

  

```csharp

// åœ¨MessageCenterä¸­æ³¨å†Œè±†åŒ…ç›¸å…³äº‹ä»¶

  

public class GameInitializer : MonoBehaviour

{

Â  Â  void Start()

Â  Â  {

Â  Â  Â  Â  // è®¢é˜…è±†åŒ…äº‹ä»¶

Â  Â  Â  Â  MessageCenter.Subscribe<string>("Voice_UserSpeech", OnUserSpeech);

Â  Â  Â  Â  MessageCenter.Subscribe<string>("Voice_AIResponse", OnAIResponse);

Â  Â  Â  Â  MessageCenter.Subscribe("Voice_Connected", OnVoiceConnected);

Â  Â  Â  Â  MessageCenter.Subscribe<string>("Voice_Error", OnVoiceError);

Â  Â  }

  

Â  Â  private void OnUserSpeech(string text)

Â  Â  {

Â  Â  Â  Â  // ç”¨æˆ·è¯´è¯æ—¶çš„é€»è¾‘

Â  Â  Â  Â  // ä¾‹å¦‚ï¼šæ˜¾ç¤ºå­—å¹•ï¼Œè§’è‰²åšå‡ºååº”

Â  Â  }

  

Â  Â  private void OnAIResponse(string text)

Â  Â  {

Â  Â  Â  Â  // AIå›å¤æ—¶çš„é€»è¾‘

Â  Â  Â  Â  // ä¾‹å¦‚ï¼šæ˜¾ç¤ºå¯¹è¯æ¡†ï¼Œæ’­æ”¾åŠ¨ç”»

Â  Â  }

  

Â  Â  private void OnVoiceConnected()

Â  Â  {

Â  Â  Â  Â  // è¿æ¥æˆåŠŸæ—¶çš„é€»è¾‘

Â  Â  Â  Â  Debug.Log("è¯­éŸ³æœåŠ¡å·²å°±ç»ª");

Â  Â  }

  

Â  Â  private void OnVoiceError(string error)

Â  Â  {

Â  Â  Â  Â  // é”™è¯¯å¤„ç†

Â  Â  Â  Â  Debug.LogError($"è¯­éŸ³æœåŠ¡é”™è¯¯: {error}");

Â  Â  }

}

```

  

#### 3.3.2 é›†æˆUnity-chanè§’è‰²

  

```csharp

/// <summary>

/// Unity-chanè¯­éŸ³äº¤äº’æ§åˆ¶å™¨

/// </summary>

public class UnityChanVoiceController : MonoBehaviour

{

Â  Â  [SerializeField] private Animator animator;

Â  Â  [SerializeField] private Audio2LipScript lipSync;

  

Â  Â  private bool _isListening;

Â  Â  private bool _isSpeaking;

  

Â  Â  void Start()

Â  Â  {

Â  Â  Â  Â  // è®¢é˜…è¯­éŸ³äº‹ä»¶

Â  Â  Â  Â  MessageCenter.Subscribe("Character_UserSpeaking", OnUserSpeaking);

Â  Â  Â  Â  MessageCenter.Subscribe<string>("Voice_AIResponse", OnAIStartSpeaking);

Â  Â  Â  Â  MessageCenter.Subscribe("LipSync_Stop", OnAISpeakingEnd);

Â  Â  }

  

Â  Â  private void OnUserSpeaking()

Â  Â  {

Â  Â  Â  Â  // ç”¨æˆ·è¯´è¯æ—¶ï¼Œè§’è‰²åœæ­¢é—²ç½®åŠ¨ç”»ï¼Œçœ‹å‘ç”¨æˆ·

Â  Â  Â  Â  animator.SetBool("IsListening", true);

Â  Â  Â  Â  animator.SetTrigger("LookAtUser");

Â  Â  }

  

Â  Â  private void OnAIStartSpeaking(string text)

Â  Â  {

Â  Â  Â  Â  // AIå¼€å§‹è¯´è¯æ—¶ï¼Œè§’è‰²æ’­æ”¾è¯´è¯åŠ¨ç”»

Â  Â  Â  Â  _isSpeaking = true;

Â  Â  Â  Â  animator.SetBool("IsSpeaking", true);

  

Â  Â  Â  Â  // å¯ä»¥æ ¹æ®æ–‡æœ¬å†…å®¹é€‰æ‹©ä¸åŒçš„è¡¨æƒ…/æ‰‹åŠ¿

Â  Â  Â  Â  if (text.Contains("ä½ å¥½") || text.Contains("æ¬¢è¿"))

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  animator.SetTrigger("Wave"); // æŒ¥æ‰‹

Â  Â  Â  Â  }

Â  Â  }

  

Â  Â  private void OnAISpeakingEnd()

Â  Â  {

Â  Â  Â  Â  // AIè¯´è¯ç»“æŸï¼Œæ¢å¤é—²ç½®çŠ¶æ€

Â  Â  Â  Â  _isSpeaking = false;

Â  Â  Â  Â  animator.SetBool("IsSpeaking", false);

Â  Â  Â  Â  animator.SetBool("IsListening", false);

Â  Â  }

}

```

  

#### 3.3.3 é›†æˆå£å‹åŒæ­¥

  

```csharp

/// <summary>

/// è±†åŒ…éŸ³é¢‘å£å‹åŒæ­¥é€‚é…å™¨

/// </summary>

public class DouBaoLipSyncAdapter : MonoBehaviour

{

Â  Â  [SerializeField] private Audio2LipScript lipSyncController;

  

Â  Â  void Start()

Â  Â  {

Â  Â  Â  Â  MessageCenter.Subscribe<byte[]>("LipSync_StartWithAudio", OnAudioReceived);

Â  Â  }

  

Â  Â  private void OnAudioReceived(byte[] audioData)

Â  Â  {

Â  Â  Â  Â  // å°†è±†åŒ…çš„OGG/OpuséŸ³é¢‘è§£ç ä¸ºPCM

Â  Â  Â  Â  // ç„¶åä¼ é€’ç»™å£å‹åŒæ­¥ç³»ç»Ÿ

  

Â  Â  Â  Â  // TODO: éœ€è¦Opusè§£ç å™¨

Â  Â  Â  Â  // byte[] pcmData = OpusDecoder.Decode(audioData);

  

Â  Â  Â  Â  // è§¦å‘å£å‹åŒæ­¥

Â  Â  Â  Â  // lipSyncController.StartSync(pcmData);

Â  Â  }

}

```

  

---

  

## 4. æ¶æ„è®¾è®¡å»ºè®®

  

### 4.1 åˆ†å±‚æ¶æ„

  

```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Â  Â  Â Presentation Layer (UI) Â  Â  Â  Â  Â  Â â”‚

â”‚ Â - å¯¹è¯UIæ˜¾ç¤º Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â - ç”¨æˆ·è¾“å…¥æ§åˆ¶ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â - çŠ¶æ€æŒ‡ç¤ºå™¨ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Â  Â Application Layer (é€»è¾‘å±‚) Â  Â  Â  Â  Â  â”‚

â”‚ Â - VoiceDialogManager (è¯­éŸ³å¯¹è¯ç®¡ç†) Â  Â  Â  Â â”‚

â”‚ Â - CharacterController (è§’è‰²æ§åˆ¶) Â  Â  Â  Â  Â  â”‚

â”‚ Â - DialogFlowManager (å¯¹è¯æµç¨‹) Â  Â  Â  Â  Â  Â  â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Â Service Layer (æœåŠ¡å±‚) Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â - IVoiceDialogService (æ¥å£) Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â - DouBaoVoiceService (è±†åŒ…å®ç°) Â  Â  Â  Â  Â  â”‚

â”‚ Â - XunFeiVoiceService (è®¯é£å®ç°) Â  Â  Â  Â  Â  â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Infrastructure Layer (åŸºç¡€è®¾æ–½) Â  Â  Â  Â  â”‚

â”‚ Â - MessageCenter (äº‹ä»¶æ€»çº¿) Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â - AudioManager (éŸ³é¢‘ç®¡ç†) Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â - NetworkManager (ç½‘ç»œç®¡ç†) Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â - LogManager (æ—¥å¿—ç³»ç»Ÿ) Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

  

### 4.2 æ¨¡å—åŒ–è®¾è®¡åŸåˆ™

  

1. **æ¥å£éš”ç¦»**ï¼šä½¿ç”¨`IVoiceDialogService`ç»Ÿä¸€ä¸åŒæœåŠ¡æä¾›å•†

2. **ä¾èµ–æ³¨å…¥**ï¼šé€šè¿‡é…ç½®åˆ‡æ¢ä¸åŒå®ç°

3. **äº‹ä»¶é©±åŠ¨**ï¼šä½¿ç”¨MessageCenterè§£è€¦æ¨¡å—

4. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½

  

### 4.3 é…ç½®ç®¡ç†

  

åˆ›å»ºScriptableObjecté…ç½®ï¼š

  

```csharp

[CreateAssetMenu(fileName = "VoiceDialogConfig", menuName = "Config/Voice Dialog")]

public class VoiceDialogConfig : ScriptableObject

{

Â  Â  [Header("æœåŠ¡é€‰æ‹©")]

Â  Â  public ServiceProvider provider = ServiceProvider.DouBao;

  

Â  Â  [Header("è±†åŒ…é…ç½®")]

Â  Â  public RTDConfig douBaoConfig;

  

Â  Â  [Header("é€šç”¨è®¾ç½®")]

Â  Â  public bool autoStartSession = true;

Â  Â  public bool enableLogging = true;

Â  Â  public float silenceTimeout = 2f;

  

Â  Â  public enum ServiceProvider

Â  Â  {

Â  Â  Â  Â  DouBao,

Â  Â  Â  Â  XunFei,

Â  Â  Â  Â  Custom

Â  Â  }

}

```

  

---

  

## 5. æœ€ä½³å®è·µ

  

### 5.1 é”™è¯¯å¤„ç†

  

```csharp

public class VoiceErrorHandler : MonoBehaviour

{

Â  Â  [SerializeField] private int maxRetryCount = 3;

Â  Â  [SerializeField] private float retryDelay = 2f;

  

Â  Â  private int _currentRetryCount;

  

Â  Â  void Start()

Â  Â  {

Â  Â  Â  Â  MessageCenter.Subscribe<string>("Voice_Error", OnVoiceError);

Â  Â  }

  

Â  Â  private void OnVoiceError(string error)

Â  Â  {

Â  Â  Â  Â  Debug.LogError($"è¯­éŸ³é”™è¯¯: {error}");

  

Â  Â  Â  Â  // æ ¹æ®é”™è¯¯ç±»å‹å¤„ç†

Â  Â  Â  Â  if (error.Contains("ç½‘ç»œ"))

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  HandleNetworkError();

Â  Â  Â  Â  }

Â  Â  Â  Â  else if (error.Contains("è®¤è¯"))

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  HandleAuthError();

Â  Â  Â  Â  }

Â  Â  Â  Â  else if (error.Contains("éº¦å…‹é£"))

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  HandleMicrophoneError();

Â  Â  Â  Â  }

Â  Â  }

  

Â  Â  private void HandleNetworkError()

Â  Â  {

Â  Â  Â  Â  if (_currentRetryCount < maxRetryCount)

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  _currentRetryCount++;

Â  Â  Â  Â  Â  Â  StartCoroutine(RetryConnection());

Â  Â  Â  Â  }

Â  Â  Â  Â  else

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  // æ˜¾ç¤ºé”™è¯¯UIï¼Œæç¤ºç”¨æˆ·æ£€æŸ¥ç½‘ç»œ

Â  Â  Â  Â  Â  Â  MessageCenter.Publish("UI_ShowError", "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®");

Â  Â  Â  Â  }

Â  Â  }

  

Â  Â  private IEnumerator RetryConnection()

Â  Â  {

Â  Â  Â  Â  yield return new WaitForSeconds(retryDelay);

Â  Â  Â  Â  VoiceDialogManager.Instance.StartConversation();

Â  Â  }

  

Â  Â  private void HandleAuthError()

Â  Â  {

Â  Â  Â  Â  // è®¤è¯å¤±è´¥ï¼Œæ£€æŸ¥é…ç½®

Â  Â  Â  Â  Debug.LogError("APIè®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®");

Â  Â  Â  Â  MessageCenter.Publish("UI_ShowError", "æœåŠ¡è®¤è¯å¤±è´¥");

Â  Â  }

  

Â  Â  private void HandleMicrophoneError()

Â  Â  {

Â  Â  Â  Â  // éº¦å…‹é£é—®é¢˜ï¼Œè¯·æ±‚æƒé™æˆ–æç¤ºç”¨æˆ·

Â  Â  Â  Â  Debug.LogError("éº¦å…‹é£ä¸å¯ç”¨");

Â  Â  Â  Â  MessageCenter.Publish("UI_ShowError", "æ— æ³•è®¿é—®éº¦å…‹é£");

Â  Â  }

}

```

  

### 5.2 çŠ¶æ€ç®¡ç†

  

```csharp

public enum VoiceDialogState

{

Â  Â  Disconnected, Â  Â // æœªè¿æ¥

Â  Â  Connecting, Â  Â  Â // æ­£åœ¨è¿æ¥

Â  Â  Connected, Â  Â  Â  // å·²è¿æ¥ä½†æœªå¼€å§‹ä¼šè¯

Â  Â  SessionActive, Â  // ä¼šè¯æ´»è·ƒ

Â  Â  Listening, Â  Â  Â  // æ­£åœ¨ç›‘å¬ç”¨æˆ·

Â  Â  AISpeaking, Â  Â  Â // AIæ­£åœ¨è¯´è¯

Â  Â  Error Â  Â  Â  Â  Â  Â // é”™è¯¯çŠ¶æ€

}

  

public class VoiceStateManager : MonoBehaviour

{

Â  Â  private VoiceDialogState _currentState = VoiceDialogState.Disconnected;

  

Â  Â  public VoiceDialogState CurrentState

Â  Â  {

Â  Â  Â  Â  get => _currentState;

Â  Â  Â  Â  private set

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  if (_currentState != value)

Â  Â  Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  Â  Â  var oldState = _currentState;

Â  Â  Â  Â  Â  Â  Â  Â  _currentState = value;

Â  Â  Â  Â  Â  Â  Â  Â  OnStateChanged(oldState, value);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  }

  

Â  Â  private void OnStateChanged(VoiceDialogState oldState, VoiceDialogState newState)

Â  Â  {

Â  Â  Â  Â  Debug.Log($"çŠ¶æ€å˜åŒ–: {oldState} â†’ {newState}");

Â  Â  Â  Â  MessageCenter.Publish("Voice_StateChanged", newState);

  

Â  Â  Â  Â  // æ ¹æ®çŠ¶æ€æ›´æ–°UI

Â  Â  Â  Â  UpdateUI(newState);

Â  Â  }

  

Â  Â  private void UpdateUI(VoiceDialogState state)

Â  Â  {

Â  Â  Â  Â  switch (state)

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  case VoiceDialogState.Listening:

Â  Â  Â  Â  Â  Â  Â  Â  // æ˜¾ç¤ºç›‘å¬æŒ‡ç¤ºå™¨

Â  Â  Â  Â  Â  Â  Â  Â  MessageCenter.Publish("UI_ShowListeningIndicator", true);

Â  Â  Â  Â  Â  Â  Â  Â  break;

  

Â  Â  Â  Â  Â  Â  case VoiceDialogState.AISpeaking:

Â  Â  Â  Â  Â  Â  Â  Â  // æ˜¾ç¤ºAIè¯´è¯æŒ‡ç¤ºå™¨

Â  Â  Â  Â  Â  Â  Â  Â  MessageCenter.Publish("UI_ShowSpeakingIndicator", true);

Â  Â  Â  Â  Â  Â  Â  Â  break;

  

Â  Â  Â  Â  Â  Â  case VoiceDialogState.Error:

Â  Â  Â  Â  Â  Â  Â  Â  // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€

Â  Â  Â  Â  Â  Â  Â  Â  MessageCenter.Publish("UI_ShowErrorIndicator", true);

Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  }

Â  Â  }

}

```

  

### 5.3 èµ„æºç®¡ç†

  

```csharp

public class VoiceResourceManager : MonoBehaviour

{

Â  Â  private AudioSource _audioSource;

Â  Â  private List<AudioClip> _audioClipCache = new List<AudioClip>();

  

Â  Â  void Start()

Â  Â  {

Â  Â  Â  Â  _audioSource = GetComponent<AudioSource>();

Â  Â  }

  

Â  Â  void OnDestroy()

Â  Â  {

Â  Â  Â  Â  // æ¸…ç†éŸ³é¢‘èµ„æº

Â  Â  Â  Â  foreach (var clip in _audioClipCache)

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  if (clip != null)

Â  Â  Â  Â  Â  Â  Â  Â  Destroy(clip);

Â  Â  Â  Â  }

Â  Â  Â  Â  _audioClipCache.Clear();

  

Â  Â  Â  Â  // ç¡®ä¿æ–­å¼€è¿æ¥

Â  Â  Â  Â  VoiceDialogManager.Instance?.EndConversation();

Â  Â  }

  

Â  Â  void OnApplicationPause(bool pauseStatus)

Â  Â  {

Â  Â  Â  Â  if (pauseStatus)

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  // åº”ç”¨æš‚åœæ—¶åœæ­¢ç›‘å¬

Â  Â  Â  Â  Â  Â  VoiceDialogManager.Instance?.StopListening();

Â  Â  Â  Â  }

Â  Â  }

}

```

  

---

  

## 6. æ€§èƒ½ä¼˜åŒ–å»ºè®®

  

### 6.1 éŸ³é¢‘å¤„ç†ä¼˜åŒ–

  

```csharp

public class AudioOptimizer : MonoBehaviour

{

Â  Â  [Header("éŸ³é¢‘ç¼“å†²è®¾ç½®")]

Â  Â  [SerializeField] private int bufferSize = 1024;

Â  Â  [SerializeField] private int numBuffers = 4;

  

Â  Â  void Start()

Â  Â  {

Â  Â  Â  Â  // é…ç½®éŸ³é¢‘ç³»ç»Ÿä»¥é™ä½å»¶è¿Ÿ

Â  Â  Â  Â  var config = AudioSettings.GetConfiguration();

Â  Â  Â  Â  config.dspBufferSize = bufferSize;

Â  Â  Â  Â  AudioSettings.Reset(config);

Â  Â  }

}

```

  

### 6.2 ç½‘ç»œä¼˜åŒ–

  

```csharp

public class NetworkOptimizer

{

Â  Â  // éŸ³é¢‘æ•°æ®å‹ç¼©ï¼ˆå¦‚æœéœ€è¦ï¼‰

Â  Â  public static byte[] CompressAudio(byte[] audioData)

Â  Â  {

Â  Â  Â  Â  // å®ç°éŸ³é¢‘å‹ç¼©é€»è¾‘

Â  Â  Â  Â  return audioData;

Â  Â  }

  

Â  Â  // æ‰¹é‡å‘é€ï¼ˆå‡å°‘ç½‘ç»œå¾€è¿”ï¼‰

Â  Â  public static void BatchSend(List<byte[]> audioChunks)

Â  Â  {

Â  Â  Â  Â  // å°†å¤šä¸ªå°éŸ³é¢‘å—åˆå¹¶å‘é€

Â  Â  }

}

```

  

### 6.3 å†…å­˜ä¼˜åŒ–

  

```csharp

public class MemoryOptimizer : MonoBehaviour

{

Â  Â  private Queue<byte[]> _audioBufferPool = new Queue<byte[]>();

Â  Â  private const int POOL_SIZE = 10;

Â  Â  private const int BUFFER_SIZE = 640;

  

Â  Â  void Start()

Â  Â  {

Â  Â  Â  Â  // é¢„åˆ†é…éŸ³é¢‘ç¼“å†²åŒº

Â  Â  Â  Â  for (int i = 0; i < POOL_SIZE; i++)

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  _audioBufferPool.Enqueue(new byte[BUFFER_SIZE]);

Â  Â  Â  Â  }

Â  Â  }

  

Â  Â  public byte[] GetBuffer()

Â  Â  {

Â  Â  Â  Â  return _audioBufferPool.Count > 0 ? _audioBufferPool.Dequeue() : new byte[BUFFER_SIZE];

Â  Â  }

  

Â  Â  public void ReturnBuffer(byte[] buffer)

Â  Â  {

Â  Â  Â  Â  if (_audioBufferPool.Count < POOL_SIZE)

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  Array.Clear(buffer, 0, buffer.Length);

Â  Â  Â  Â  Â  Â  _audioBufferPool.Enqueue(buffer);

Â  Â  Â  Â  }

Â  Â  }

}

```

  

---

  

## 7. å¸¸è§åœºæ™¯å®ç°

  

### 7.1 åœºæ™¯1ï¼šè™šæ‹ŸåŠ©æ‰‹

  

```csharp

public class VirtualAssistant : MonoBehaviour

{

Â  Â  void Start()

Â  Â  {

Â  Â  Â  Â  // å¯åŠ¨å¯¹è¯æœåŠ¡

Â  Â  Â  Â  VoiceDialogManager.Instance.StartConversation();

  

Â  Â  Â  Â  // å‘é€åˆå§‹é—®å€™

Â  Â  Â  Â  StartCoroutine(SendInitialGreeting());

Â  Â  }

  

Â  Â  IEnumerator SendInitialGreeting()

Â  Â  {

Â  Â  Â  Â  yield return new WaitForSeconds(1f);

Â  Â  Â  Â  VoiceDialogManager.Instance.SendText("ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„è™šæ‹ŸåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ");

Â  Â  }

}

```

  

### 7.2 åœºæ™¯2ï¼šNPCå¯¹è¯

  

```csharp

public class NPCDialog : MonoBehaviour

{

Â  Â  [SerializeField] private string npcName = "å•†åº—è€æ¿";

Â  Â  [SerializeField] private string npcPersonality = "çƒ­æƒ…å‹å¥½çš„å•†äºº";

  

Â  Â  private bool _isInConversation;

  

Â  Â  void OnTriggerEnter(Collider other)

Â  Â  {

Â  Â  Â  Â  if (other.CompareTag("Player") && !_isInConversation)

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  StartDialogWithPlayer();

Â  Â  Â  Â  }

Â  Â  }

  

Â  Â  private void StartDialogWithPlayer()

Â  Â  {

Â  Â  Â  Â  _isInConversation = true;

  

Â  Â  Â  Â  // é…ç½®AIè§’è‰²

Â  Â  Â  Â  var config = new RTDConfig

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  botName = npcName,

Â  Â  Â  Â  Â  Â  systemRole = $"ä½ æ˜¯{npcName}ï¼Œ{npcPersonality}",

Â  Â  Â  Â  Â  Â  // ... å…¶ä»–é…ç½®

Â  Â  Â  Â  };

  

Â  Â  Â  Â  VoiceDialogManager.Instance.StartConversation();

Â  Â  Â  Â  VoiceDialogManager.Instance.StartListening();

Â  Â  }

  

Â  Â  void OnTriggerExit(Collider other)

Â  Â  {

Â  Â  Â  Â  if (other.CompareTag("Player") && _isInConversation)

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  EndDialogWithPlayer();

Â  Â  Â  Â  }

Â  Â  }

  

Â  Â  private void EndDialogWithPlayer()

Â  Â  {

Â  Â  Â  Â  _isInConversation = false;

Â  Â  Â  Â  VoiceDialogManager.Instance.EndConversation();

Â  Â  }

}

```

  

### 7.3 åœºæ™¯3ï¼šè¯­éŸ³å‘½ä»¤æ§åˆ¶

  

```csharp

public class VoiceCommandHandler : MonoBehaviour

{

Â  Â  private Dictionary<string, Action> _commands = new Dictionary<string, Action>();

  

Â  Â  void Start()

Â  Â  {

Â  Â  Â  Â  RegisterCommands();

Â  Â  Â  Â  MessageCenter.Subscribe<string>("Voice_UserSpeech", OnUserCommand);

Â  Â  }

  

Â  Â  private void RegisterCommands()

Â  Â  {

Â  Â  Â  Â  _commands["æ‰“å¼€åœ°å›¾"] = OpenMap;

Â  Â  Â  Â  _commands["å…³é—­åœ°å›¾"] = CloseMap;

Â  Â  Â  Â  _commands["æŸ¥çœ‹èƒŒåŒ…"] = OpenInventory;

Â  Â  Â  Â  _commands["ä¿å­˜æ¸¸æˆ"] = SaveGame;

Â  Â  }

  

Â  Â  private void OnUserCommand(string speech)

Â  Â  {

Â  Â  Â  Â  foreach (var cmd in _commands)

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  if (speech.Contains(cmd.Key))

Â  Â  Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  Â  Â  cmd.Value?.Invoke();

Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  }

  

Â  Â  private void OpenMap() { /* å®ç° */ }

Â  Â  private void CloseMap() { /* å®ç° */ }

Â  Â  private void OpenInventory() { /* å®ç° */ }

Â  Â  private void SaveGame() { /* å®ç° */ }

}

```

  

---

  

## 8. æ³¨æ„äº‹é¡¹ä¸é£é™©

  

### 8.1 æŠ€æœ¯é£é™©

  

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |

|------|------|---------|

| ç½‘ç»œå»¶è¿Ÿ | é«˜ | æ·»åŠ é‡è¿æœºåˆ¶ï¼Œæ˜¾ç¤ºç½‘ç»œçŠ¶æ€ |

| éŸ³é¢‘è§£ç  | é«˜ | é›†æˆOpusè§£ç åº“ |

| éº¦å…‹é£æƒé™ | ä¸­ | æå‰è¯·æ±‚æƒé™ï¼Œå‹å¥½æç¤º |

| APIè´¹ç”¨ | ä¸­ | ç›‘æ§ä½¿ç”¨é‡ï¼Œè®¾ç½®é¢„ç®— |

| æœåŠ¡ç¨³å®šæ€§ | ä¸­ | å®ç°é™çº§æ–¹æ¡ˆï¼ˆè®¯é£å¤‡ç”¨ï¼‰ |

  

### 8.2 ç”¨æˆ·ä½“éªŒé£é™©

  

1. **å»¶è¿Ÿæ„ŸçŸ¥**

Â  Â - é—®é¢˜ï¼šç”¨æˆ·å¯èƒ½æ„Ÿè§‰å“åº”æ…¢

Â  Â - è§£å†³ï¼šæ·»åŠ "æ­£åœ¨æ€è€ƒ..."åŠ¨ç”»

  

2. **è¯†åˆ«é”™è¯¯**

Â  Â - é—®é¢˜ï¼šASRè¯†åˆ«é”™è¯¯å¯¼è‡´è¯¯è§£

Â  Â - è§£å†³ï¼šå…è®¸ç”¨æˆ·é‡æ–°è¾“å…¥æˆ–æ–‡æœ¬ä¿®æ­£

  

3. **ä¸­æ–­å¤„ç†**

Â  Â - é—®é¢˜ï¼šç”¨æˆ·æ‰“æ–­AIè¯´è¯

Â  Â - è§£å†³ï¼šæ£€æµ‹ç”¨æˆ·å¼€å§‹è¯´è¯æ—¶åœæ­¢AIæ’­æ”¾

  

### 8.3 å®‰å…¨æ³¨æ„äº‹é¡¹

  

```csharp

public class SecurityManager : MonoBehaviour

{

Â  Â  // âš ï¸ ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç APIå¯†é’¥

Â  Â  // âœ… ä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡

  

Â  Â  [SerializeField] private TextAsset configFile; // ä½¿ç”¨å¤–éƒ¨é…ç½®

  

Â  Â  void Start()

Â  Â  {

Â  Â  Â  Â  // ä»é…ç½®æ–‡ä»¶è¯»å–

Â  Â  Â  Â  var config = JsonUtility.FromJson<SecureConfig>(configFile.text);

  

Â  Â  Â  Â  // âš ï¸ ä¸è¦åœ¨æ—¥å¿—ä¸­æ‰“å°æ•æ„Ÿä¿¡æ¯

Â  Â  Â  Â  Debug.Log($"Using App ID: {MaskString(config.apiAppId)}");

Â  Â  }

  

Â  Â  private string MaskString(string input)

Â  Â  {

Â  Â  Â  Â  if (string.IsNullOrEmpty(input) || input.Length < 8)

Â  Â  Â  Â  Â  Â  return "****";

Â  Â  Â  Â  return input.Substring(0, 4) + "****" + input.Substring(input.Length - 4);

Â  Â  }

}

```

  

### 8.4 æˆæœ¬æ§åˆ¶

  

```csharp

public class UsageMonitor : MonoBehaviour

{

Â  Â  private float _sessionStartTime;

Â  Â  private float _totalUsageTime;

  

Â  Â  [SerializeField] private float dailyTimeLimit = 3600f; // 1å°æ—¶

  

Â  Â  void Start()

Â  Â  {

Â  Â  Â  Â  MessageCenter.Subscribe("Voice_Connected", OnSessionStart);

Â  Â  Â  Â  MessageCenter.Subscribe("Voice_Disconnected", OnSessionEnd);

Â  Â  }

  

Â  Â  private void OnSessionStart()

Â  Â  {

Â  Â  Â  Â  _sessionStartTime = Time.time;

Â  Â  }

  

Â  Â  private void OnSessionEnd()

Â  Â  {

Â  Â  Â  Â  float duration = Time.time - _sessionStartTime;

Â  Â  Â  Â  _totalUsageTime += duration;

  

Â  Â  Â  Â  Debug.Log($"æœ¬æ¬¡ä¼šè¯æ—¶é•¿: {duration:F2}ç§’ï¼Œä»Šæ—¥ç´¯è®¡: {_totalUsageTime:F2}ç§’");

  

Â  Â  Â  Â  if (_totalUsageTime > dailyTimeLimit)

Â  Â  Â  Â  {

Â  Â  Â  Â  Â  Â  Debug.LogWarning("å·²è¾¾åˆ°æ¯æ—¥ä½¿ç”¨é™é¢");

Â  Â  Â  Â  Â  Â  // åˆ‡æ¢åˆ°å¤‡ç”¨æ–¹æ¡ˆæˆ–æç¤ºç”¨æˆ·

Â  Â  Â  Â  }

Â  Â  }

}

```

  

---

  

## 9. å®æ–½è·¯çº¿å›¾

  

### é˜¶æ®µ1ï¼šåŸºç¡€é›†æˆï¼ˆ1-2å‘¨ï¼‰

  

- [ ] åˆ›å»º`IVoiceDialogService`æ¥å£

- [ ] å®ç°`DouBaoVoiceService`

- [ ] é›†æˆåˆ°`MessageCenter`

- [ ] åŸºç¡€è¿æ¥å’Œä¼šè¯æµ‹è¯•

  

### é˜¶æ®µ2ï¼šåŠŸèƒ½å®Œå–„ï¼ˆ1-2å‘¨ï¼‰

  

- [ ] å®ç°é”™è¯¯å¤„ç†å’Œé‡è¿

- [ ] æ·»åŠ çŠ¶æ€ç®¡ç†

- [ ] é›†æˆè§’è‰²åŠ¨ç”»

- [ ] UIåé¦ˆç³»ç»Ÿ

  

### é˜¶æ®µ3ï¼šé«˜çº§åŠŸèƒ½ï¼ˆ2-3å‘¨ï¼‰

  

- [ ] OpuséŸ³é¢‘è§£ç 

- [ ] å£å‹åŒæ­¥é›†æˆ

- [ ] æ€§èƒ½ä¼˜åŒ–

- [ ] å¤šåœºæ™¯æµ‹è¯•

  

### é˜¶æ®µ4ï¼šä¼˜åŒ–ä¸æµ‹è¯•ï¼ˆ1-2å‘¨ï¼‰

  

- [ ] ç”¨æˆ·ä½“éªŒä¼˜åŒ–

- [ ] æ€§èƒ½å‹æµ‹

- [ ] æˆæœ¬ç›‘æ§

- [ ] æ–‡æ¡£å®Œå–„

  

---

  

## 10. æ€»ç»“ä¸å»ºè®®

  

### æ¨èæ–¹æ¡ˆ

  

**å¯¹äºæ‚¨çš„é¡¹ç›®ï¼Œæˆ‘å¼ºçƒˆæ¨èã€Œæ–¹æ¡ˆAï¼šå®Œå…¨æ›¿æ¢ã€**

  

**ç†ç”±ï¼š**

1. âœ… è±†åŒ…æä¾›ç«¯åˆ°ç«¯è§£å†³æ–¹æ¡ˆï¼Œæ¯”æ‹¼æ¥å¤šä¸ªæœåŠ¡æ›´ç¨³å®š

2. âœ… å»¶è¿Ÿæ›´ä½ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½

3. âœ… ç»´æŠ¤æˆæœ¬ä½ï¼Œåªéœ€å¯¹æ¥ä¸€ä¸ªæœåŠ¡

4. âœ… åŠŸèƒ½å®Œæ•´ï¼ŒASR + AI + TTS ä¸€ä½“åŒ–

  

### å¿«é€Ÿå¼€å§‹æ­¥éª¤

  

1. åˆ›å»º`VoiceDialogManager`å•ä¾‹

2. å®ç°`DouBaoVoiceService`é€‚é…å™¨

3. é›†æˆåˆ°ç°æœ‰`MessageCenter`äº‹ä»¶ç³»ç»Ÿ

4. æµ‹è¯•åŸºç¡€å¯¹è¯æµç¨‹

5. é€æ­¥æ·»åŠ è§’è‰²åŠ¨ç”»å’ŒUIåé¦ˆ

  

### å…³é”®æˆåŠŸå› ç´ 

  

1. **è‰¯å¥½çš„æ¥å£è®¾è®¡** - ä¾¿äºåˆ‡æ¢ä¸åŒæœåŠ¡å•†

2. **å®Œå–„çš„é”™è¯¯å¤„ç†** - æå‡ç¨³å®šæ€§

3. **æµç•…çš„ç”¨æˆ·ä½“éªŒ** - åŠæ—¶åé¦ˆï¼Œä½å»¶è¿Ÿ

4. **æ¨¡å—åŒ–æ¶æ„** - ä¾¿äºç»´æŠ¤å’Œæ‰©å±•

  

---

  

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0

**åˆ›å»ºæ—¶é—´**ï¼š2026-01-09

**é€‚ç”¨é¡¹ç›®**ï¼šYiTiJi_Move (Unity-chan Voice Dialog)

**ä½œè€…**ï¼šClaude Sonnet 4.5